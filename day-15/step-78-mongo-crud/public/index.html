<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>CRUD App</title>
    <!-- CSS Only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <script src="lib/jquery-3.6.0.js"></script>
    <script>
        $(function () {
            // $("#adduserbox").hide(2000);
            refresh();

            // adding listeners
            $("#usergrid").on('click', '.btn-danger', function (evt) {
                $.ajax({
                    method: 'delete',
                    url: '/delete/' + $(evt.target).attr('data-del'),
                    success: function (res) {
                        console.log(res);
                    },
                    error: function (err) {
                        console.log('Error: ', err);
                    },
                })
            })

            $("#addBtn").on('click', function () {
                if ($("#username").val() || $("#useremail").val() || $("#usercity").val()) {
                    let nuser = {
                        username: $("#username").val(),
                        useremail: $("#useremail").val(),
                        usercity: $("#usercity").val()
                    };

                    $.ajax({
                        method: 'post',
                        url: "/add",
                        data: JSON.stringify(nuser),
                        contentType: 'application/json',
                        dataType: 'json',
                        success: function (res) {
                            console.log(res);
                        },
                        error: function (err) {
                            console.log('Error', err);
                        }
                    })
                } else {
                    alert('Please fill all the user deatils.');
                }
            });
        })

        function refresh() {
            $.ajax({
                url: "/data",
                success: function (res, statusText, jqxhr) {
                    // console.log('Response: ', res['users']);
                    $(res.users).each(function (idx) {
                        // $("#usergrid").html("");
                        $("#usergrid").append(
                            `<tr>
                                <th scope="row">${idx+1}</th>
                                <td>${res['users'][idx].username}</td>
                                <td>${res['users'][idx].useremail}</td>
                                <td>${res['users'][idx].usercity}</td>
                                <td><button data-del="${res['users'][idx]._id}" class="btn btn-warning">Edit User</button></td>
                                <td><button data-del="${res['users'][idx]._id}" class="btn btn-danger">Delete User</button></td>
                            </tr>`
                        );
                    });
                },
                error: function (jqxhr, textStatus, error) {
                    console.log('Error: ', error);
                }
            });
        }
    </script>
</head>

<body>
    <h1>Express CRUD</h1>

    <hr />

    <div id="adduserbox">
        <div class="mb-3">
            <label for="username" class="form-label">User Name</label>
            <input type="text" class="form-control" id="username">
        </div>
        <div class="mb-3">
            <label for="useremail" class="form-label">User eMail</label>
            <input type="text" class="form-control" id="useremail">
        </div>
        <div class="mb-3">
            <label for="usercity" class="form-label">User City</label>
            <input type="text" class="form-control" id="usercity">
        </div>
        <button id="addBtn" type="submit" class="btn btn-primary">Add User</button>
    </div>

    <hr />

    <h2 class="text-center">Users Grid</h2>

    <table class="table">
        <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">User Name</th>
                <th scope="col">User eMail</th>
                <th scope="col">User City</th>
                <th scope="col">Edit User</th>
                <th scope="col">Delete User</th>
            </tr>
        </thead>
        <tbody id="usergrid">
        </tbody>
    </table>
</body>

</html>